import { HttpClient } from '@angular/common/http';
import { Component, ElementRef, OnInit, ViewChild } from '@angular/core';
import { Router } from '@angular/router';
import { GameStatusService } from '../../services/game-status.service';
import { TimerService } from '../../services/timer.service';
import { Resp } from '../keypads/keypads.component';

declare var LeaderLine: any;

@Component({
  selector: 'app-wires',
  templateUrl: './wires.component.html',
  styleUrls: ['./wires.component.css'],
})
export class WiresComponent implements OnInit {
  buttonsPressed: HTMLButtonElement[] = [];
  lines: any[] = [];
  solution: any = [];
  message: string = '';
  @ViewChild('modal') modal!: ElementRef;

  constructor(
    private router: Router,
    private http: HttpClient,
    public timerService: TimerService,
    private gameSolved: GameStatusService
  ) {
    router.events.subscribe((val) => {
      this.clearArray();
    });
  }

  ngOnInit(): void {
    // this.timerService.ngOnInit();
  }

  drawLine(point: HTMLButtonElement) {
    if (this.buttonsPressed.length == 1) {
      this.buttonsPressed.push(point);
      if (
        (!this.buttonsPressed[0].classList.contains('firstColumn') &&
          !this.buttonsPressed[1].classList.contains('secondColumn')) ||
        (!this.buttonsPressed[0].classList.contains('secondColumn') &&
          !this.buttonsPressed[1].classList.contains('firstColumn'))
      ) {
        const line = new LeaderLine(
          this.buttonsPressed[0],
          this.buttonsPressed[1],

          {
            startPlug: 'disc',
            endPlug: 'disc',
            hide: true,
          }
        );
        line.show('draw', { duration: 250, timing: 'linear' });
        this.lines.push(line);

        if (
          this.buttonsPressed[1].classList.contains('firstColumn') ||
          this.buttonsPressed[0].classList.contains('secondColumn')
        ) {
          let aux = this.buttonsPressed[1];
          this.buttonsPressed[1] = this.buttonsPressed[0];
          this.buttonsPressed[0] = aux;
        }

        this.solution[Number(this.buttonsPressed[1].id)] =
          this.buttonsPressed[0].value;

        this.buttonsPressed.length = 0;
      } else {
        this.buttonsPressed.length = 0;
      }
    } else {
      this.buttonsPressed.push(point);
    }
  }

  clearArray() {
    this.buttonsPressed.length = 0;
    this.lines.forEach((element) => {
      element.remove();
    });
    this.lines.length = 0;
  }

  submit() {
    this.solution.shift();
    if (this.solution.length === 4) {
      if (this.solution.includes('ping')) {
        this.solution.splice(this.solution.indexOf('ping'), 1);
      }

      this.http
        .post(`https://suas206-vm.su.ro.conti.de:36299/WireRightOrder2`, {
          input: this.solution,
        })
        .subscribe({
          next: (response: Resp | any) => {
            if (response.status === 200) {
              this.message = 'Bravo! Treci la urmatoarea problema.';
            } else {
              this.message = 'Problema persista. Mai incearca!';
            }

            this.modal.nativeElement.showModal();
          },
          error: (error) => {
            console.log(error);
          },
        });
    }
  }

  closeModal() {
    if (this.message === 'Bravo sefule, treci la urmatorul') {
      this.router.navigate(['/game-select']);
      this.gameSolved.gameSolved.emit({ game: '/wires', solved: true });
    } else {
      this.clearArray();
    }
    this.modal.nativeElement.close();
  }
}
